name: CI

on:
  push:
    branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/dev' }}

env:
  CI: true
  # Database (for test jobs - matches PostgreSQL service)
  DATABASE_URL: postgres://postgres:postgres@localhost:5432/f3_test
  TEST_DATABASE_URL: postgres://postgres:postgres@localhost:5432/f3_test
  # Auth (mock)
  AUTH_SECRET: ci-auth-secret-placeholder-32chars
  # Email (mocks)
  EMAIL_SERVER: smtp://user:pass@localhost:587
  EMAIL_FROM: ci@example.com
  EMAIL_ADMIN_DESTINATIONS: ci@example.com
  # Google (mocks)
  GOOGLE_LOGO_BUCKET_PRIVATE_KEY: mock-private-key
  GOOGLE_LOGO_BUCKET_CLIENT_EMAIL: mock@example.iam.gserviceaccount.com
  GOOGLE_LOGO_BUCKET_BUCKET_NAME: mock-bucket
  # API (mocks)
  API_KEY: ci-api-key-placeholder
  SUPER_ADMIN_API_KEY: ci-super-admin-key-placeholder
  # Next.js (mocks)
  NEXT_PUBLIC_API_URL: http://localhost:3001
  NEXT_PUBLIC_MAP_URL: http://localhost:3000
  NEXT_PUBLIC_CHANNEL: ci
  NEXT_PUBLIC_GOOGLE_API_KEY: ci-google-api-key-placeholder
  NEXT_PUBLIC_MAP_API_KEY: ci-map-api-key-placeholder

jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm format

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm build

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: f3_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm test

  test-coverage:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: f3_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:coverage
